@page "/reset-password"
@using Microsoft.AspNetCore.Identity
@using FinanceTracker.Models
@inject UserManager<ApplicationUser> UserManager
@inject NavigationManager Nav

<div class="container mt-5">
    <div class="col-md-6 mx-auto card p-4 shadow">
        <h4>Neues Passwort festlegen</h4>
        <input type="email" class="form-control mb-2" @bind="email" placeholder="Email" />
        <input type="text" class="form-control mb-2" @bind="code" placeholder="4-stelliger Admin-Code" />
        <input type="password" class="form-control mb-2" @bind="newPass" placeholder="Neues Passwort" />

        <button class="btn btn-success w-100" @onclick="ConfirmReset">Passwort speichern</button>
    </div>
</div>

@code {
    private string email = "", code = "", newPass = "";

    private async Task ConfirmReset()
    {
        var user = await UserManager.FindByEmailAsync(email);
        if (user != null && user.IsPasswordResetPending && user.PasswordResetCode == code)
        {
            var token = await UserManager.GeneratePasswordResetTokenAsync(user);
            var result = await UserManager.ResetPasswordAsync(user, token, newPass);

            if (result.Succeeded)
            {
                user.IsPasswordResetPending = false;
                user.PasswordResetCode = null;
                await UserManager.UpdateAsync(user);
                Nav.NavigateTo("Identity/Account/Login");
            }
        }
    }
}
@using Microsoft.AspNetCore.Components.Authorization
@using FinanceTracker.Data
@using Microsoft.EntityFrameworkCore
@inject AuthenticationStateProvider AuthProvider
@inject AppDbContext DbContext

<div class="top-row ps-3 navbar navbar-dark">
    <div class="container-fluid">
        <a class="navbar-brand" href="">
            <span class="bi bi-piggy-bank-fill me-2" aria-hidden="true"></span>FinanceTracker
        </a>
    </div>
</div>

<input type="checkbox" title="Navigation menu" class="navbar-toggler" />

<div class="nav-scrollable" onclick="document.querySelector('.navbar-toggler').click()">
    <nav class="flex-column">

        <div class="nav-item px-3 py-2 text-white-50 small text-uppercase fw-bold" style="font-size: 0.7rem; letter-spacing: 1px;">
            Allgemein
        </div>
        <div class="nav-item px-3">
            <NavLink class="nav-link" href="" Match="NavLinkMatch.All">
                <span class="bi bi-house-door-fill" aria-hidden="true"></span> Home
            </NavLink>
        </div>

        <AuthorizeView>
            <Authorized>
                <hr class="text-white-50 mx-3 my-2" />

                <div class="nav-item px-3 py-2 text-white-50 small text-uppercase fw-bold" style="font-size: 0.7rem; letter-spacing: 1px;">
                    Eigene Finanzen
                </div>
                <div class="nav-item px-3">
                    <NavLink class="nav-link" href="tracker">
                        <span class="bi bi-wallet2" aria-hidden="true"></span> Finanz-Tracker
                    </NavLink>
                </div>

                <hr class="text-white-50 mx-3 my-2" />

                <div class="nav-item px-3 py-2 text-white-50 small text-uppercase fw-bold" style="font-size: 0.7rem; letter-spacing: 1px;">
                    Soziales & Schulden
                </div>
                <div class="nav-item px-3">
                    <NavLink class="nav-link" href="debts">
                        <span class="bi bi-people-fill" aria-hidden="true"></span> Gläubiger-Verwaltung
                    </NavLink>
                </div>

                <hr class="text-white-50 mx-3 my-2" />

                <div class="nav-item px-3">
                    <div class="nav-link text-info">
                        <span class="bi bi-person-circle" aria-hidden="true"></span> @context.User.Identity?.Name
                    </div>
                </div>
                <div class="nav-item px-3">
                    <form action="Identity/Account/Logout" method="post">
                        <AntiforgeryToken />
                        <input type="hidden" name="ReturnUrl" value="" />
                        <button type="submit" class="nav-link btn btn-link w-100 text-start text-white border-0">
                            <span class="bi bi-box-arrow-left" aria-hidden="true"></span> Abmelden
                        </button>
                    </form>
                </div>
            </Authorized>

            <NotAuthorized>
                <hr class="text-white-50 mx-3 my-2" />
                <div class="nav-item px-3">
                    <NavLink class="nav-link" href="Identity/Account/Register">
                        <span class="bi bi-person-plus-fill" aria-hidden="true"></span> Registrieren
                    </NavLink>
                </div>
                <div class="nav-item px-3">
                    <NavLink class="nav-link" href="Identity/Account/Login">
                        <span class="bi bi-unlock-fill" aria-hidden="true"></span> Login
                    </NavLink>
                </div>
            </NotAuthorized>
        </AuthorizeView>
    </nav>
</div>
@code {
    private string? userFirstName;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        if (user.Identity?.IsAuthenticated == true)
        {
            var userId = user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
            var dbUser = await DbContext.Users.FindAsync(userId);
            userFirstName = dbUser?.FirstName ?? user.Identity.Name;
        }
    }
}